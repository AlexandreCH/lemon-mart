version: 2.1
orbs:
  aws-cli: circleci/aws-cli@1.0.0
  aws-ecr: circleci/aws-ecr@6.8.2
jobs:
  build:
    docker:
      - image: circleci/node:lts
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Execute Pipeline (Build Source -> Test -> Build Web Server)
          command: |
            docker build -f integration.Dockerfile . -t lemon-mart:$CIRCLE_BRANCH
            mkdir -p docker-cache
            docker save lemon-mart:$CIRCLE_BRANCH | gzip > docker-cache/built-image.tar.gz

      - store_artifacts:
          path: docker-cache/built-image.tar.gz
          destination: built-image.tar.gz
      - run:
          name: Move compiled app to workspace
          command: |
            set -exu
            mkdir -p /tmp/workspace
            mv docker-cache/built-image.tar.gz /tmp/workspace/
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - .

  deploy:
    executor: aws-cli/default
    working_directory: ~/repo
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - checkout
      - setup_remote_docker
      - aws-cli/setup
      # - run:
      #     name: Sign into AWS ecr
      #     command: eval $(aws ecr get-login)
      # - run:
      #     name: Push it to ECR
      #     command: |
      #       docker load < /tmp/workspace/built-image.tar.gz
      #       docker tag my_app:$CIRCLE_BRANCH $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/lemon-mart:$CIRCLE_BRANCH
      #       docker push $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/lemon-mart:$CIRCLE_BRANCH
      - run:
          name: Deploy
          command: npm run aws:deploy

workflows:
  version: 2
  build-and-deploy:
    jobs:
      # - build
      - aws-ecr/build-and-push-image:
          aws-access-key-id: ${AWS_ACCESS_KEY}
          aws-secret-access-key: ${AWS_SECRET_ACCESS_KEY}
          dockerfile: integration.Dockerfile
          path: .
          repo: lemon-mart
          tag: 'latest,${CIRCLE_BUILD_NUM}'
      - deploy:
          requires:
            - aws-ecr/build-and-push-image
# Deployment Integrations https://circleci.com/docs/2.0/deployment-integrations
# For Docker Hub deploy see https://circleci.com/docs/2.0/building-docker-images/
# For AWS ECS deploy see https://circleci.com/blog/how-to-build-a-docker-image-on-circleci-2-0/
# For Heroku see https://devcenter.heroku.com/articles/container-registry-and-runtime#pushing-an-image-s
# For cache optimization read https://medium.com/@gajus/making-docker-in-docker-builds-x2-faster-using-docker-cache-from-option-c01febd8ef84
